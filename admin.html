<!DOCTYPE html>
<html lang="es">

<head>
  <button id="activarNoti" style="display:none"></button>
  <meta charset="UTF-8">
  <title>Admin ¬∑ Sabores de Pereira</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      margin: 0;
      font-family: Segoe UI, Tahoma, sans-serif;
      background: #f3f4f6;
    }

    header {
      background: #111827;
      color: white;
      padding: 18px;
      text-align: center;
      font-weight: 900;
      font-size: 20px;
    }

    .container {
      max-width: 1000px;
      margin: auto;
      padding: 20px;
    }

    input,
    select {
      width: 100%;
      padding: 12px;
      margin-bottom: 12px;
      border-radius: 12px;
      border: 1px solid #ccc;
    }

    .pedido {
      background: white;
      padding: 14px;
      border-radius: 14px;
      margin-bottom: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .1);
      cursor: pointer;
    }

    .pedido-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .codigo {
      background: #111827;
      color: white;
      padding: 4px 10px;
      border-radius: 10px;
      font-size: 13px;
    }

    .estado {
      font-size: 13px;
      font-weight: 800;
    }

    .total {
      color: #16a34a;
      font-weight: 900;
    }

    /* MODAL */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .6);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      width: 90%;
      max-width: 520px;
      border-radius: 18px;
      padding: 20px;
      max-height: 85%;
      overflow: auto;
    }

    .close {
      text-align: right;
      color: #ef4444;
      font-weight: 700;
      cursor: pointer;
    }

    /* FOOTER */
    footer {
      background: #111827;
      color: #ddd;
      padding: 25px;
      text-align: center;
      font-size: 13px;
    }

    footer strong {
      color: white;
    }
  </style>
</head>

<body>

  <header>üì¶ Panel de Pedidos ¬∑ Sabores de Pereira</header>

  <div class="container">
    <input type="search" id="search" placeholder="Buscar por nombre o c√≥digo">
    <div id="lista"></div>
  </div>

  <!-- MODAL -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="close" onclick="cerrarModal()">Cerrar ‚úñ</div>
      <div id="detalle"></div>
    </div>
  </div>

  <footer>
    <strong>SABORES DE PEREIRA</strong><br>
    üìç Pereira, Colombia<br>
    üìû +56 9 5651 0930<br>
    ‚è∞ Horario: 17:00 a 23:00<br>
    ¬© 2026 ¬∑ Panel interno
  </footer>

  <script type="module">
    let pedidosAnteriores = new Set();

    /* ================= FIREBASE ================= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      onSnapshot,
      query,
      orderBy,
      doc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCHYo8LYSyOqgr6tBgo9RXODH0KRwZeowQ",
      authDomain: "live-de-eso.firebaseapp.com",
      projectId: "live-de-eso",
      storageBucket: "live-de-eso.firebasestorage.app",
      messagingSenderId: "250545251960",
      appId: "1:250545251960:web:94ad354f2650d46d32af8d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ================= PEDIDOS ================= */
    const lista = document.getElementById("lista");
    const search = document.getElementById("search");
    const modal = document.getElementById("modal");
    const detalle = document.getElementById("detalle");
    let pedidos = [];

    const q = query(collection(db, "pedidos"), orderBy("fecha", "desc"));

    onSnapshot(q, snap => {
  snap.docChanges().forEach(change => {
    if (change.type === "added") {
      if (!pedidosAnteriores.has(change.doc.id)) {
        notificarPedido(change.doc.data());
        pedidosAnteriores.add(change.doc.id);
      }
    }
  });

  pedidos = [];
  snap.forEach(d => {
    pedidos.push({ id: d.id, ...d.data() });
    pedidosAnteriores.add(d.id);
  });

  render();
});



    function render() {
      const f = search.value.toLowerCase();
      lista.innerHTML = "";
      pedidos
        .filter(p =>
          p.codigo.toLowerCase().includes(f) ||
          p.cliente.nombre.toLowerCase().includes(f)
        )
        .forEach(p => {
          const fecha = p.fecha?.toDate().toLocaleString();
          const div = document.createElement("div");
          div.className = "pedido";
          div.innerHTML = `
        <div class="pedido-header">
          <div>${p.cliente.nombre}</div>
          <div class="codigo">${p.codigo}</div>
        </div>
        <div>${fecha}</div>
        <div class="total">$${p.total}</div>
        <div class="estado">Estado: ${p.estado}</div>
      `;
          div.onclick = () => verDetalle(p);
          lista.appendChild(div);
        });
    }
    search.oninput = render;

    /* ================= DETALLE ================= */
    function verDetalle(p) {
      detalle.innerHTML = `
    <h3>Pedido ${p.codigo}</h3>
    <p><b>Cliente:</b> ${p.cliente.nombre}</p>
    <p><b>Tel√©fono:</b> ${p.cliente.telefono}</p>
    <p><b>Hora:</b> ${p.fecha.toDate().toLocaleString()}</p>

    <h4>Productos</h4>
    <ul>
      ${p.items.map(i => `<li>${i.name} ${i.size} - $${i.price}</li>`).join("")}
    </ul>

    <p><b>Total:</b> $${p.total}</p>

    <select onchange="cambiarEstado('${p.id}',this.value)">
      <option ${p.estado === "nuevo" ? "selected" : ""}>nuevo</option>
      <option ${p.estado === "confirmado" ? "selected" : ""}>confirmado</option>
      <option ${p.estado === "listo" ? "selected" : ""}>listo</option>
      <option ${p.estado === "entregado" ? "selected" : ""}>entregado</option>
    </select>
  `;
      modal.classList.add("active");
    }

    window.cerrarModal = () => modal.classList.remove("active");

    /* ================= ESTADO ================= */
    window.cambiarEstado = async (id, estado) => {
      await updateDoc(doc(db, "pedidos", id), { estado });
    };

    function notificarPedido(pedido) {
      if (Notification.permission === "granted") {
        new Notification("üì¶ Pedido nuevo", {
          body: `${pedido.cliente.nombre} - $${pedido.total}`,
          icon: "icon-192.png"
        });
      }
    }

    setTimeout(() => {
      if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
      }
    }, 1500);


  </script>

</body>

</html>